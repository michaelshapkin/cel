#!/usr/bin/env python3
import os
import sys
import csv
import subprocess
import time
import shutil
from pathlib import Path

# --- Configuration ---
WORKSPACE_DIR = Path(__file__).parent.absolute()
BENCHMARK_CSV = WORKSPACE_DIR / "data" / "benchmark.csv"
CONTRACTS_DIR = WORKSPACE_DIR / "data" / "contracts"
DOTENV_PATH = WORKSPACE_DIR / ".env"

# Load environment variables
from dotenv import load_dotenv
load_dotenv(DOTENV_PATH)
ANKR_KEY = os.getenv("ANKR_API_KEY", "")

# Use .venv if it exists in the current WORKSPACE_DIR
VENV_PYTHON = WORKSPACE_DIR / ".venv" / "bin" / "python3"
if VENV_PYTHON.exists():
    PYTHON_EXE = str(VENV_PYTHON.absolute())
else:
    # Fallback to current sys.executable or just "python3"
    PYTHON_EXE = sys.executable

# RPC URLs
RPC_URLS = {
    "bsc": f"https://rpc.ankr.com/bsc/{ANKR_KEY}",
    "mainnet": f"https://rpc.ankr.com/eth/{ANKR_KEY}",
    "optimism": f"https://rpc.ankr.com/optimism/{ANKR_KEY}",
    "base": f"https://rpc.ankr.com/base/{ANKR_KEY}"
}

def run_command(cmd, cwd=None):
    # Mask sensitive information in logs
    cmd_str = ' '.join(cmd)
    if ANKR_KEY and ANKR_KEY in cmd_str:
        log_str = cmd_str.replace(ANKR_KEY, "********")
    else:
        log_str = cmd_str
        
    print(f"[*] Executing: {log_str}")
    result = subprocess.run(cmd, cwd=cwd, capture_output=True, text=True)
    if result.returncode != 0:
        print(f"[!] Error: {result.stderr}")
        return None
    return result.stdout

def get_case_metadata(address):
    if not BENCHMARK_CSV.exists():
        print(f"[!] Error: {BENCHMARK_CSV} not found.")
        return None
    
    with open(BENCHMARK_CSV, "r") as f:
        reader = csv.DictReader(f)
        for row in reader:
            if row['target_contract_address'].lower() == address.lower():
                return row
    return None

def main():
    if len(sys.argv) < 2:
        print("Usage: python3 run_case.py <contract_address>")
        sys.exit(1)

    target_addr = sys.argv[1]
    metadata = get_case_metadata(target_addr)

    if not metadata:
        print(f"[!] Case {target_addr} not found in benchmark.csv")
        sys.exit(1)

    chain = metadata['chain'].strip('" ')
    block = metadata['fork_block_number']
    case_name = metadata['case_name'].strip('" ')
    rpc_url = RPC_URLS.get(chain, RPC_URLS["bsc"])

    print(f"ðŸš€ Starting Case: {case_name} ({chain} @ {block})")

    # --- STEP 1: FETCH SOURCES ---
    print("[*] Step 1: Locating source code...")
    local_case_path = CONTRACTS_DIR / case_name
    
    sources_ready = False
    
    if local_case_path.exists():
        print(f"[+] Found case '{case_name}' in data archive.")
        sources_ready = True
    else:
        print(f"[*] Case '{case_name}' not in archive. Attempting to fetch from Etherscan...")
        run_command([PYTHON_EXE, "core/fetcher.py", target_addr])
        if (CONTRACTS_DIR / target_addr).exists():
            sources_ready = True

    # --- STEP 2: START CONTAINER & ANVIL ---
    container_name = f"cel-sim-{target_addr[:8]}"
    print(f"[*] Step 2: Starting simulator container '{container_name}'...")
    subprocess.run(["docker", "rm", "-f", container_name], capture_output=True)

    docker_cmd = [
        "docker", "run", "-d",
        "--name", container_name,
        "-p", "8545:8545",
        "-e", f"FORK_URL={rpc_url}",
        "-e", f"FORK_BLOCK={block}",
        "-v", f"{WORKSPACE_DIR}/core:/usr/local/bin/tools/core",
        "-v", f"{WORKSPACE_DIR}/data:/usr/local/bin/tools/data",
        "scone-simulator"
    ]
    run_command(docker_cmd)

    print("[*] Waiting for Anvil to stabilize (15s)...")
    time.sleep(15)

    # --- STEP 3: GENERATE PROMPT ---
    print("[*] Step 3: Generating system prompt...")
    # Update call to use the new path
    prompt_out = run_command([PYTHON_EXE, "core/generate_context.py", target_addr])
    if prompt_out:
        with open("system_prompt.txt", "w") as f:
            f.write(prompt_out)
        print("[+] System prompt saved to system_prompt.txt")

    # --- STEP 4: PROVISION FILES ---
    print("[*] Step 4: Provisioning sources into container...")
    run_command(["docker", "exec", container_name, "mkdir", "-p", "/workdir/etherscan-contracts"])
    
    if sources_ready:
        if local_case_path.exists():
            for item in local_case_path.iterdir():
                if item.is_dir():
                    addr = item.name.lower()
                    run_command(["docker", "exec", container_name, "mkdir", "-p", f"/workdir/etherscan-contracts/{addr}"])
                    subprocess.run(["docker", "cp", f"{str(item)}/.", f"{container_name}:/workdir/etherscan-contracts/{addr}/"])
                    print(f"[+] Provisioned: /workdir/etherscan-contracts/{addr}/")
        else:
            # If fetched by fetcher.py
            local_fetch_path = CONTRACTS_DIR / target_addr
            if local_fetch_path.exists():
                run_command(["docker", "exec", container_name, "mkdir", "-p", f"/workdir/etherscan-contracts/{target_addr}"])
                subprocess.run(["docker", "cp", f"{str(local_fetch_path)}/.", f"{container_name}:/workdir/etherscan-contracts/{target_addr}/"])
                print(f"[+] Provisioned: /workdir/etherscan-contracts/{target_addr}/")

    print("\n" + "="*50)
    print(f"âœ… CASE READY: {case_name}")
    print(f"Container: {container_name}")
    print(f"Prompt:    system_prompt.txt")
    print(f"To enter:  docker exec -it {container_name} bash")
    print("="*50)

if __name__ == "__main__":
    main()