import os
import requests
import json
import sys
import csv
from pathlib import Path
from dotenv import load_dotenv

# Path setup relative to CEL root
CORE_DIR = Path(__file__).parent.absolute()
CEL_ROOT = CORE_DIR.parent
BENCHMARK_CSV = CEL_ROOT / "data" / "benchmark.csv"
CONTRACTS_DIR = CEL_ROOT / "data" / "contracts"

load_dotenv(CEL_ROOT / ".env")

def get_chain_id(address):
    if not BENCHMARK_CSV.exists():
        return "56" # Default to BSC
    with open(BENCHMARK_CSV, "r") as f:
        reader = csv.DictReader(f)
        for row in reader:
            if row["target_contract_address"].lower() == address.lower():
                chain = row["chain"].strip('" ')
                if chain == "bsc": return "56"
                if chain == "mainnet": return "1"
                if chain == "optimism": return "10"
                if chain == "base": return "8453"
    return "56"

def fetch_source(address, api_key, chain_id):
    # Etherscan V2 API endpoint
    url = f"https://api.etherscan.io/v2/api?chainid={chain_id}&module=contract&action=getsourcecode&address={address}&apikey={api_key}"
    
    print(f"[*] Fetching source for {address} (ChainID: {chain_id})...")
    try:
        response = requests.get(url)
        data = response.json()
    except Exception as e:
        print(f"[!] Network error: {e}")
        return

    if data.get('status') != '1':
        print(f"[!] API Error: {data.get('message')}")
        return

    result = data['result'][0]
    source_code = result['SourceCode']
    contract_name = result['ContractName']

    if not source_code:
        print("[!] Source code not verified on Explorer.")
        return

    # Save to data/contracts
    base_path = CONTRACTS_DIR / address / contract_name
    base_path.mkdir(parents=True, exist_ok=True)

    if source_code.startswith('{{'):
        print("[+] Multi-file structure detected.")
        json_content = source_code[1:-1]
        try:
            source_data = json.loads(json_content)
            sources = source_data.get('sources', source_data)
            for file_path, content_obj in sources.items():
                full_path = base_path / file_path
                full_path.parent.mkdir(parents=True, exist_ok=True)
                content = content_obj.get('content', content_obj) if isinstance(content_obj, dict) else content_obj
                with open(full_path, "w", encoding="utf-8") as f:
                    f.write(content)
                print(f"  - Saved: {file_path}")
        except Exception as e:
            print(f"[!] Error parsing JSON: {e}")
    else:
        print("[+] Single file detected.")
        with open(base_path / f"{contract_name}.sol", "w", encoding="utf-8") as f:
            f.write(source_code)
        print(f"  - Saved: {contract_name}.sol")

    print(f"[OK] Source saved to: {base_path}")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 fetcher.py <address>")
        sys.exit(1)

    target = sys.argv[1]
    cid = get_chain_id(target)
    
    # Select API key based on chain
    if cid == "56": key = os.getenv("BSC_API_KEY")
    elif cid == "1": key = os.getenv("ETHERSCAN_API_KEY")
    elif cid == "10": key = os.getenv("OPTIMISM_API_KEY")
    elif cid == "8453": key = os.getenv("BASE_API_KEY")
    else: key = os.getenv("ETHERSCAN_API_KEY")

    if not key:
        print("[!] API Key not found in .env")
        sys.exit(1)

    fetch_source(target, key, cid)
