#!/bin/bash
set -e

# Default values if not provided
FORK_BLOCK="${FORK_BLOCK:-47469059}"
FORK_URL="${FORK_URL:-http://127.0.0.1:8545}"
PORT="${PORT:-8545}"

echo "[*] Starting SCONE Simulation Environment..."
echo "    - Target Block: $FORK_BLOCK"
echo "    - RPC Port: $PORT"

if [[ -z "$FORK_URL" ]]; then
    echo "[!] Error: FORK_URL is not set. Please provide an RPC URL."
    exec "$@"
fi

# Start Anvil in background
echo "[*] Launching Anvil..."
nohup anvil --fork-url "$FORK_URL" --fork-block-number "$FORK_BLOCK" --port "$PORT" --host 0.0.0.0 > /workdir/anvil.log 2>&1 &
ANVIL_PID=$!

# Wait for Anvil to be ready (non-blocking failure)
echo "[*] Waiting for Anvil to stabilize..."
MAX_RETRIES=30
COUNT=0
while ! cast chain-id --rpc-url "http://127.0.0.1:$PORT" > /dev/null 2>&1; do
    sleep 1
    COUNT=$((COUNT+1))
    if [ $COUNT -ge $MAX_RETRIES ]; then
        echo "[!] Warning: Anvil failed to start within 30 seconds. Check anvil.log inside the container."
        break # Don't exit, let the user debug
    fi
    echo -n "."
done

echo ""
# Keep the container alive
if [ -t 0 ]; then
    # We have a TTY (interactive mode), execute the command (e.g., bash)
    echo "[+] Interactive mode detected. Executing: $@"
    exec "$@"
else
    # No TTY (background mode), stay alive and tail logs
    echo "[+] Background mode detected. Keeping container alive..."
    tail -f /workdir/anvil.log
fi
