# Use official Python 3.11 slim image
FROM python:3.11-slim-bookworm

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Install Foundry (forge, cast, anvil)
RUN curl -L https://foundry.paradigm.xyz | bash
ENV PATH="/root/.foundry/bin:${PATH}"
RUN /root/.foundry/bin/foundryup

# Install solc-select for multi-version Solidity support
RUN pip install solc-select
# Pre-install common versions to speed up runtime
RUN solc-select install 0.4.24 && \
    solc-select install 0.5.16 && \
    solc-select install 0.6.12 && \
    solc-select install 0.7.6 && \
    solc-select install 0.8.0 && \
    solc-select install 0.8.10 && \
    solc-select install 0.8.20 && \
    solc-select use 0.8.20

# Set working directory inside container
WORKDIR /workdir

# Install Python dependencies
COPY docker_requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# Link our custom tools so they are always available
RUN mkdir -p /usr/local/bin/tools/core /usr/local/bin/tools/data

# Copy compiler manager
COPY core/compiler_manager.py /usr/local/bin/tools/core/compiler_manager.py

# --- FOUNDRY PROJECT SETUP ---
WORKDIR /workdir/flaw_verifier
RUN git init && \
    /root/.foundry/bin/forge init --force . && \
    /root/.foundry/bin/forge install openzeppelin/openzeppelin-contracts && \
    /root/.foundry/bin/forge install openzeppelin/openzeppelin-contracts-upgradeable && \
    rm src/Counter.sol test/Counter.t.sol script/Counter.s.sol

# Copy templates into the image
COPY templates/foundry/FlawVerifier_Template.sol src/FlawVerifier.sol
COPY templates/foundry/FlawVerifier.s.sol script/FlawVerifier.s.sol
COPY templates/foundry/FlawVerifier.t.sol test/FlawVerifier.t.sol

WORKDIR /workdir

RUN echo '#!/bin/bash\npython3 /usr/local/bin/tools/core/uniswap-smart-path.py "$@"' > /usr/local/bin/uniswap-smart-path && \
    chmod +x /usr/local/bin/uniswap-smart-path

RUN echo '#!/bin/bash\npython3 /usr/local/bin/tools/core/generate_context.py "$@"' > /usr/local/bin/generate-context && \
    chmod +x /usr/local/bin/generate-context

RUN echo '#!/bin/bash\npython3 /usr/local/bin/tools/core/compiler_manager.py "$@"' > /usr/local/bin/manage-compiler && \
    chmod +x /usr/local/bin/manage-compiler

# Copy and setup entrypoint
COPY entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/entrypoint.sh



# Expose Anvil default port

EXPOSE 8545



ENTRYPOINT ["entrypoint.sh"]

CMD ["/bin/bash"]
